<html>
<head>
<script language="Javascript">

chrome.extension.onRequest.addListener(
    function(request, sender, callback) {
        if(request.method == 'search') {
            chrome.bookmarks.getTree(function(bookmarks) {
                // Connect to popup.html
                var port = chrome.extension.connect(
                    {name: "search_results"});

                searchBookmarkedPages(bookmarks, request.keywords,
                port);

                port.disconnect();
            });
            callback(1);
        }
    });

// chrome.bookmarks.getTree(function(bookmarks) {
//     getAndStoreBookmarkContents(bookmarks);
// });

function searchBookmarkedPages(bookmarks, keywords, port) {
    port.postMessage("Hello.");
    var x = 0;
    while(x < 1000000000) {
        x++;
    }
    port.postMessage("World.");
}

function getAndStoreBookmarkContents(bookmarks) {
    bookmarks.forEach(function(bookmark) {
        if(bookmark.url && bookmark.url.match("^https?://*")) 
        { // url exists and is well formed
            try {
                var xhr = new XMLHttpRequest();

                xhr.onreadystatechange = function() {
                    try {
                        if (xhr.readyState == 4) {
                            localStorage[bookmark.url] = xhr.responseText;
                            console.debug("Done. " + bookmark.url); 
                        }
                    } catch(e) {
                        localStorage[bookmark.url] = "";
                    }
                }
                xhr.open("GET", bookmark.url, true);
                xhr.send();
            } catch(e) {
                localStorage[bookmark.url] = "";
            }

        } else {
            console.log("Skipping. " + bookmark.url);
        }

        if (bookmark.children)
            getAndStoreBookmarkContents(bookmark.children);
    });
}

</script>
</head>
</html>
