<html>
<head>
<script language="Javascript">

var SearchMarkDB = {};
var gAddedUrls = [];

SearchMarkDB.db = null;
SearchMarkDB.open = function() {
    var dbSize = 200 * 1024 * 1024; // 200 MB
    SearchMarkDB.db = openDatabase('SearchMarkDB', 
                                   '1.0', 'Bookmark Page Storage', 
                                   dbSize);
}

SearchMarkDB.onError = function(tx, e) {
    console.log(e.message);
}

SearchMarkDB.onAdded = function(tx, r) {
    console.log("Added. " + gAddedUrls.pop());
}

SearchMarkDB.onClear = function(tx, r) {
    console.log("Cleared SearchMark database.");
}

SearchMarkDB.showAllBookmarks = function(tx, r) {
    for(var i = 0; i < r.rows.length; i++) {
        console.log("Stored. " + r.rows.item(i).url);
    }
}

SearchMarkDB.createTable = function() {
    SearchMarkDB.db.transaction(function(tx) {
        tx.executeSql('CREATE TABLE IF NOT EXISTS ' + 
                      'pages(url TEXT PRIMARY KEY, page TEXT)', []);
    });
}

SearchMarkDB.addBookmarkedPage = function(newUrl, newPage) {
    SearchMarkDB.db.transaction(function(tx){
        tx.executeSql('INSERT INTO pages(url, page) VALUES (?,?)', 
                      [newUrl, newPage],
                      SearchMarkDB.onAdded,
                      SearchMarkDB.onError);
    });
}

SearchMarkDB.getStoredBookmarks = 
    function(callback) {
        SearchMarkDB.db.transaction(function(tx) {
            tx.executeSql('SELECT url FROM pages', 
                          [], 
                          callback,
                          SearchMarkDB.onError);
        });
    }

SearchMarkDB.searchBookmarkedPages = 
    function(keywords, callback) {
        SearchMarkDB.db.transaction(function(tx) {
            var searchTxt = "'%" + keywords + "%'";
            tx.executeSql("SELECT url FROM pages WHERE "
                          + "page LIKE " + searchTxt + " OR " 
                          + "url LIKE " + searchTxt,
                          [],
                          callback, 
                          SearchMarkDB.onError);
        });
    }

SearchMarkDB.clear = function() {
    SearchMarkDB.db.transaction(function(tx) {
        tx.executeSql('DELETE FROM pages', [],
                      SearchMarkDB.onClear,
                      SearchMarkDB.onError);
    });
}

SearchMarkDB.open();
console.debug("Opened SearchMark database.");

// SearchMarkDB.getStoredBookmarks(SearchMarkDB.showAllBookmarks);
// SearchMarkDB.clear();
// localStorage['initialized'] = "no";

if(!localStorage['initialized'] ||
   localStorage['initialized'] != "yes") {
    SearchMarkDB.createTable();

    chrome.bookmarks.getTree(function(bookmarks) {
        getAndStoreBookmarkContents(bookmarks);
    });

    localStorage['initialized'] = "yes";
    
    console.debug("Saving Bookmarked pages to SearchMark database.");
}

chrome.extension.onRequest.addListener(
    function(request, sender, callback) {
        if(request.method == 'search') {
            SearchMarkDB.searchBookmarkedPages(
                request.keywords,
                searchPageCb);
            
            callback('');
        }
    });

// function searchBookmarkedPages(bookmarks, keywords, results) {
//     bookmarks.forEach(function(bookmark) {
//         if(bookmark.url && bookmark.url.match("^https?://*")) 
//         { // url exists and is well formed
//             if(bookmark.url.match(keywords)) {
//                 results.push(bookmark.url);
//                 console.log(bookmark.url);
//                 console.log(localStorage[bookmark.url]);
//             } else if(localStorage[bookmark.url].match(keywords)) {
//                 results.push(bookmark.url);
//                 console.log(bookmark.url);
//             }
//         }
        
//         if (bookmark.children)
//             searchBookmarkedPages(bookmark.children, keywords, results);
//     });
// }

function searchPageCb(tx, rs) {
    for(var i = 0; i < rs.rows.length; i++) {
        console.log(rs.rows.item(i).url);
    }
}

function getAndStoreBookmarkContents(bookmarks) {
    bookmarks.forEach(function(bookmark) {
        if(bookmark.url && bookmark.url.match("^https?://*")) 
        { // url exists and is well formed
            try {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", bookmark.url, true);
                xhr.onreadystatechange = function() {
                    try {
                        if (xhr.readyState == 4) {
                            SearchMarkDB.addBookmarkedPage(
                                bookmark.url, 
                                xhr.responseText);
                            gAddedUrls.push(bookmark.url);
                        }
                    } catch(e) {
                        console.log(e.message);
                        SearchMarkDB.addBookmarkedPage(
                            bookmark.url, 
                            "Error retrieving page.");
                    }
                }
                xhr.send();
            } catch(e) {
                console.log(e.message + bookmark.url);
                SearchMarkDB.addBookmarkedPage(
                    bookmark.url, 
                    "Error retrieving page.");
            }
        } else {
            console.debug("Skipping. " + bookmark.url);
        }

        if (bookmark.children)
            getAndStoreBookmarkContents(bookmark.children);
    });
}
</script>
</head>
</html>
