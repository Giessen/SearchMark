<html>
<head>
<script language="Javascript">

chrome.extension.onRequest.addListener(
    function(request, sender, callback) {
        if(request.method == 'search') {
            chrome.bookmarks.getTree(function(bookmarks) {
                var results = [];

                searchBookmarkedPages(bookmarks, 
                                      request.keywords, 
                                      results);

                callback(results);
            });
        }
    });

chrome.bookmarks.getTree(function(bookmarks) {
    localStorage.clear();
    console.log(localStorage.length);
    getAndStoreBookmarkContents(bookmarks);
});

function searchBookmarkedPages(bookmarks, keywords, results) {
    bookmarks.forEach(function(bookmark) {
        if(bookmark.url && bookmark.url.match("^https?://*")) 
        { // url exists and is well formed
            if(bookmark.url.match(keywords)) {
                results.push(bookmark.url);
                console.log(bookmark.url);
                console.log(localStorage[bookmark.url]);
            } else if(localStorage[bookmark.url].match(keywords)) {
                results.push(bookmark.url);
                console.log(bookmark.url);
            }
        }
        
        if (bookmark.children)
            searchBookmarkedPages(bookmark.children, keywords, results);
    });
}

function getAndStoreBookmarkContents(bookmarks) {
    bookmarks.forEach(function(bookmark) {
        if(bookmark.url && bookmark.url.match("^https?://*")) 
        { // url exists and is well formed
            try {
                console.debug("Indexing " + bookmark.url); 

                var xhr = new XMLHttpRequest();
                xhr.open("GET", bookmark.url, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4) {
                        localStorage[bookmark.url] =
                            xhr.responseText;
                        console.debug(localStorage.length);
                    }
                }
                xhr.send();
            } catch(e) {
                console.log("NET Exception. " + bookmark.url);
                localStorage[bookmark.url] = "";
            }

        } else {
            console.log("Skipping. " + bookmark.url);
        }

        if (bookmark.children)
            getAndStoreBookmarkContents(bookmark.children);
    });
}

</script>
</head>
</html>
