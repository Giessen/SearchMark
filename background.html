<html>
<head>
<script language="Javascript">

chrome.extension.onRequest.addListener(
    function(request, sender, callback) {
        if(request.method == 'search') {
            chrome.bookmarks.getTree(function(bookmarks) {
                var results = [];

                searchBookmarkedPages(bookmarks, 
                                      request.keywords, 
                                      results);

                callback(results);
            });
        }
    });

// chrome.bookmarks.getTree(function(bookmarks) {
//     getAndStoreBookmarkContents(bookmarks);
// });

function searchBookmarkedPages(bookmarks, keywords, results) {
    results.push("Search continues.");
    results.push("Search done.");
}

function getAndStoreBookmarkContents(bookmarks) {
    bookmarks.forEach(function(bookmark) {
        if(bookmark.url && bookmark.url.match("^https?://*")) 
        { // url exists and is well formed
            try {
                var xhr = new XMLHttpRequest();

                xhr.onreadystatechange = function() {
                    try {
                        if (xhr.readyState == 4) {
                            localStorage[bookmark.url] = xhr.responseText;
                            console.debug("Done. " + bookmark.url); 
                        }
                    } catch(e) {
                        localStorage[bookmark.url] = "";
                    }
                }
                xhr.open("GET", bookmark.url, true);
                xhr.send();
            } catch(e) {
                localStorage[bookmark.url] = "";
            }

        } else {
            console.log("Skipping. " + bookmark.url);
        }

        if (bookmark.children)
            getAndStoreBookmarkContents(bookmark.children);
    });
}

</script>
</head>
</html>
