<html>
<head>
<script language="Javascript">    
    var newWinId = -1;

function tabUpdateListener(tabId, changeInfo, tab) {
    console.log("in tab listener");
    if(tab.windowId == newWinId && changeInfo.status == "complete") {
        chrome.tabs.remove(tabId);
    } else {
        console.log("still loading " + tab.url);
    }
}

chrome.extension.onRequest.addListener(
    function(request, sender, callback) {
        if(request.method == 'getBookmarkedContent') {
            console.debug("Got message getBookmarkedContent");
            
            
            //                 chrome.bookmarks.getTree(function(bookmarks) {
            //                     loadBookmarkContents(bookmarks);
            //                 });
            
            chrome.tabs.onUpdated.addListener(tabUpdateListener);
            
            chrome.windows.create(
                {'url':"http://www.yahoo.com"}, 
                function(newWin) {
                    newWinId = newWin.id;
                });
              
            // chrome.tabs.onUpdated.removeListener(tabUpdateListener);
            callback('');
        } else {
            callback('');
        }
    });

function loadBookmarkContents(bookmarks) {
    bookmarks.forEach(function(bookmark) {
        console.debug(bookmark.id + ' - ' + bookmark.title + ' - ' +
                      bookmark.url);
        
        var newWinId = 0;
        
        if(bookmark.url && bookmark.url.match("http://*")) {
            chrome.windows.create({'url':bookmark.url}, 
                                  function(newWin) {
                                      newWinId = newWin.id;
                                  });
        }
        
        chrome.tabs.onUpdated.addListener(
            function(tabId, changeInfo, tab) {
                if(changeInfo.status == "complete") {
                    chrome.tabs.remove(tabId);
                }
            });
        
        if (bookmark.children && newWinId == 0) {
            loadBookmarkContents(bookmark.children);
        }
        
    });
}
</script>
</head>
</html>
